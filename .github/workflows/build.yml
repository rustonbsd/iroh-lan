name: Build and Release iroh-lan UI

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  network-stress-test:
    name: Network Stress Test (Docker)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Stress Test
        # Run test for 2 minutes to ensure stability
        run: |
          export GAME_TEST_DURATION=2
          make stress-test

  approve-build:
    name: Approve Build
    needs: network-stress-test
    runs-on: ubuntu-latest
    environment: ui-build
    steps:
      - run: echo "Manual approval received."

  build-tauri:
    name: Build Tauri ${{ matrix.platform.name }}
    needs: approve-build
    runs-on: ${{ matrix.platform.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Windows targets
          - name: Windows x86_64
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            ext: ".exe"
            os_suffix: "windows-x86_64"
          # - name: Windows i686 (32-bit)
          #   runs-on: windows-latest
          #   target: i686-pc-windows-msvc
          #   ext: ".exe"
          #   os_suffix: "windows-i686"
          # - name: Windows ARM64
          #   runs-on: windows-latest
          #   target: aarch64-pc-windows-msvc
          #   ext: ".exe"
          #   os_suffix: "windows-arm64"

          # Linux targets
          - name: Linux x86_64
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            ext: ""
            os_suffix: "linux-x86_64"
          # - name: Linux i686 (32-bit)
          #   runs-on: ubuntu-latest
          #   target: i686-unknown-linux-gnu
          #   ext: ""
          #   os_suffix: "linux-i686"
          # - name: Linux ARM64
          #   runs-on: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
          #   ext: ""
          #   os_suffix: "linux-arm64"

          # macOS targets
          - name: macOS x86_64
            runs-on: macos-latest
            target: x86_64-apple-darwin
            ext: ""
            os_suffix: "macos-x86_64"
          - name: macOS ARM64 (Apple Silicon)
            runs-on: macos-latest
            target: aarch64-apple-darwin
            ext: ""
            os_suffix: "macos-arm64"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform.runs-on == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version '^2.0.0'

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.platform.target }}-tauri
          workspaces: ui/src-tauri

      - name: Install frontend dependencies
        working-directory: ui
        run: pnpm install

      - name: Build Tauri app
        working-directory: ui/src-tauri
        run: cargo tauri build --target ${{ matrix.platform.target }}

      - name: Prepare Tauri binary
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          EXT="${{ matrix.platform.ext }}"
          OS_SUFFIX="${{ matrix.platform.os_suffix }}"

          OUTDIR="dist-tauri/${OS_SUFFIX}"
          mkdir -p "${OUTDIR}"

          # Find and copy the Tauri binary
          TAURI_BIN="ui/src-tauri/target/${TARGET}/release/iroh-lan-ui${EXT}"
          if [ -f "${TAURI_BIN}" ]; then
            cp "${TAURI_BIN}" "${OUTDIR}/iroh-lan-ui-${OS_SUFFIX}${EXT}"
            chmod +x "${OUTDIR}/iroh-lan-ui-${OS_SUFFIX}${EXT}" || true
          else
            echo "Warning: Tauri binary not found at ${TAURI_BIN}"
            echo "Searching for binary..."
            find ui/src-tauri/target/${TARGET}/release -type f -name "iroh-lan-ui*" || true
          fi

          echo "Resulting files:"
          ls -la "${OUTDIR}" || true

      - name: Upload Tauri artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iroh-lan-ui-${{ matrix.platform.os_suffix }}
          path: dist-tauri/${{ matrix.platform.os_suffix }}/*
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-tauri]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy Tauri UI binaries directly (no zipping)
          find artifacts/iroh-lan-ui-* -type f -exec cp {} release-assets/ \;

          ls -lh release-assets/

      - name: Create Release Draft
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          draft: true
          prerelease: false
          generate_release_notes: true
          name: Release ${{ github.ref_name }}
          body: |
            ## iroh-lan UI Release ${{ github.ref_name }}

            ### Downloads

            **Windows:**
            - `iroh-lan-ui-windows-x86_64.exe` - Windows 64-bit (Intel/AMD)

            **Linux:**
            - `iroh-lan-ui-linux-x86_64` - Linux 64-bit (Intel/AMD)

            **macOS:**
            - `iroh-lan-ui-macos-x86_64` - macOS Intel
            - `iroh-lan-ui-macos-arm64` - macOS Apple Silicon (M1/M2/M3)

            ### Installation

            1. Download the appropriate binary for your platform
            2. Make it executable (Linux/macOS): `chmod +x iroh-lan-ui-*`
            3. Run the application

            ---

            **Note:** Execution requires admin/sudo rights to create the tun network interface. This is a standalone binary with no dependencies required.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}